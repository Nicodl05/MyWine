name: Security Scan

# Minimal reusable workflow for lightweight security checks.
# Kept intentionally simple to avoid YAML pitfalls and allow easy extension.
on:
  workflow_call:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Check vulnerable packages
        run: |
          echo "Checking for vulnerable packages"
          dotnet list package --vulnerable --include-transitive || true

      - name: Check deprecated packages
        run: |
          echo "Checking for deprecated packages"
          dotnet list package --deprecated || true

      - name: Scan for potential hardcoded secrets
        run: |
          echo "Scanning source files for potential hardcoded secrets"
          # Grep may fail with exit code when matches are found; return non-zero only if we want to fail the job
          MATCHES=$(grep -R -n -E "(password|pwd|secret|key|token)\s*=\s*['\"]" src/ --include="*.cs" --include="*.json" || true)
          if [ -n "$MATCHES" ]; then
            echo "Potential hardcoded secrets found:";
            echo "$MATCHES";
            exit 1;
          else
            echo "No obvious hardcoded secrets detected"
          fi
